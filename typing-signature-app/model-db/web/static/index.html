<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Keystroke Web Demo</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    input, button, select, textarea { padding: 8px; margin: 4px 0; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    .col { flex: 1 1 320px; }
    .box { width: 100%; height: 120px; border: 1px dashed #aaa; border-radius: 6px; padding: 8px; }
    .muted { color: #666; font-size: 12px; }
    .log { white-space: pre-wrap; font-family: ui-monospace, monospace; font-size: 12px; }
  </style>
  <script>
    let currentEvents = [];
    let pressMap = new Map();
    let startTime = performance.now();

    function resetCapture() {
      currentEvents = [];
      pressMap.clear();
      startTime = performance.now();
      document.getElementById('events').textContent = '';
    }

    function keyToChar(e) {
      if (e.key.length === 1) return e.key; // printable
      return null;
    }

    function onKeyDown(e) {
      const c = keyToChar(e);
      if (c === null) return;
      const t = (performance.now() - startTime) / 1000.0;
      if (!pressMap.has(c)) pressMap.set(c, []);
      pressMap.get(c).push(t);
    }

    function onKeyUp(e) {
      const c = keyToChar(e);
      if (c === null) return;
      const t = (performance.now() - startTime) / 1000.0;
      const arr = pressMap.get(c) || [];
      if (arr.length > 0) {
        const press = arr.shift();
        if (t >= press) {
          currentEvents.push({ press, release: t, key: c });
          document.getElementById('events').textContent = JSON.stringify(currentEvents[currentEvents.length - 1]);
        }
      }
    }

    function bindCapture(el) {
      el.addEventListener('focus', () => { resetCapture(); });
      el.addEventListener('keydown', onKeyDown);
      el.addEventListener('keyup', onKeyUp);
    }

    async function api(path, method, body) {
      const res = await fetch(path, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: body ? JSON.stringify(body) : undefined
      });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    async function refreshConfig() {
      const cfg = await api('/api/config', 'GET');
      document.getElementById('seq_len').textContent = cfg.seq_len;
      document.getElementById('threshold').textContent = (cfg.threshold ?? 'N/A');
      document.getElementById('users').textContent = cfg.users.join(', ');
    }

    async function deleteAll() {
      if (!confirm('모든 등록 사용자를 삭제할까요?')) return;
      const out = await api('/api/users','DELETE');
      document.getElementById('log').textContent = JSON.stringify(out, null, 2);
      await refreshConfig();
    }

    async function enrollOnce() {
      const user = document.getElementById('user').value.trim();
      const sessions = Number(document.getElementById('sessions').value) || 3;
      if (!user) { alert('user를 입력하세요'); return; }

      const phrase = document.getElementById('enroll_phrase');
      phrase.value = '';
      phrase.focus();

      alert('문구를 타이핑 후 입력을 멈추세요. 완료되면 OK를 누르세요.');
      // freeze snapshot
      const eventsCopy = [...currentEvents];

      const body = { user, sessions: [eventsCopy] };
      const out = await api('/api/enroll', 'POST', body);
      document.getElementById('log').textContent = JSON.stringify(out, null, 2);
      await refreshConfig();
    }

    async function verify() {
      const user = document.getElementById('user').value.trim();
      if (!user) { alert('user를 입력하세요'); return; }
      const verifyBox = document.getElementById('verify_phrase');
      verifyBox.value = '';
      verifyBox.focus();
      alert('검증할 문구를 타이핑 후 완료되면 OK를 누르세요.');
      const eventsCopy = [...currentEvents];
      const out = await api('/api/verify', 'POST', { user, events: eventsCopy });
      document.getElementById('log').textContent = JSON.stringify(out, null, 2);
    }

    async function identify() {
      const idBox = document.getElementById('identify_phrase');
      idBox.value = '';
      idBox.focus();
      alert('식별할 문구를 타이핑 후 완료되면 OK를 누르세요.');
      const eventsCopy = [...currentEvents];
      const out = await api('/api/identify', 'POST', { events: eventsCopy, topk: 3 });
      document.getElementById('log').textContent = JSON.stringify(out, null, 2);
    }

    window.addEventListener('DOMContentLoaded', async () => {
      bindCapture(document.getElementById('enroll_phrase'));
      bindCapture(document.getElementById('verify_phrase'));
      bindCapture(document.getElementById('identify_phrase'));
      await refreshConfig();
    });
  </script>
</head>
<body>
  <h2>Keystroke Web Demo</h2>
  <div class="muted">seq_len: <span id="seq_len"></span> | threshold(EER): <span id="threshold"></span> | users: <span id="users"></span></div>
  <div style="margin:8px 0">
    <button onclick="deleteAll()">모든 사용자 삭제</button>
  </div>
  <div class="row">
    <div class="col">
      <div class="card">
        <h3>1) Enroll</h3>
        <label>user</label>
        <input id="user" placeholder="USER1" />
        <label>sessions</label>
        <input id="sessions" type="number" min="1" max="5" value="1" />
        <div class="muted">아래 입력창 포커스 후 문구를 타이핑하면 자동 기록됩니다.</div>
        <textarea id="enroll_phrase" class="box" placeholder="여기에 타이핑"></textarea>
        <div><button onclick="enrollOnce()">Enroll (1 snapshot)</button></div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <h3>2) Verify</h3>
        <div class="muted">등록한 사용자명으로 다시 입력해 보세요.</div>
        <textarea id="verify_phrase" class="box" placeholder="여기에 타이핑"></textarea>
        <div><button onclick="verify()">Verify</button></div>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <h3>3) Identify</h3>
        <div class="muted">등록된 사용자들 중 최상 매칭을 찾습니다.</div>
        <textarea id="identify_phrase" class="box" placeholder="여기에 타이핑"></textarea>
        <div><button onclick="identify()">Identify</button></div>
      </div>
    </div>
  </div>
  <div class="card">
    <h3>Events snapshot (마지막)</h3>
    <div id="events" class="log"></div>
  </div>
  <div class="card">
    <h3>Response</h3>
    <div id="log" class="log"></div>
  </div>
</body>
</html>


